pipeline {
   agent none
    stages {
        stage ('load154') {
            agent { node { label 'load154' } }
            steps {
                dir('/local/jenkins/hkpn') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/HKPN',
                    branch: 'main'
                }
            }
        }
        stage ('load155') {
            agent { node { label 'load155' } }
            steps {
                dir('/local/jenkins/hkpn') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/HKPN',
                    branch: 'main'
                }
            }
        }

        stage ('load210') {
            agent { node { label 'load210' } }
            steps {
                dir('/local/jenkins/hkpn_test') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/HKPN',
                    branch: 'main'
                }
            }
        }

        stage ('build-test') {
            agent { node { label 'load210' } }
            steps {
                dir('/local/jenkins/hkpn') {
                    sh 'docker build --pull -f Dockerfile-test-web --tag kortforsyningen/hkpn-web:test-latest --tag kortforsyningen/hkpn-web:test-$BUILD_NUMBER .'
                    sh 'docker image push kortforsyningen/hkpn-web:test-latest'
                    sh 'docker image push kortforsyningen/hkpn-web:test-$BUILD_NUMBER'
                }
            }
        }

        stage ('deploy-test') {
            agent { node { label 'load154' } }
            steps {
                dir('/local/jenkins/hkpn') {
                    sh 'docker stack deploy -c swarm.test.yml hkpn_test --with-registry-auth --resolve-image always'
                }
            }
        }
    }
}
