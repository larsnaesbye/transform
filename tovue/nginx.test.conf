#user  nobody;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


pcre_jit on;
timer_resolution 1s;

events {
    use epoll;
    worker_connections  1024;
    worker_aio_requests 8;
    multi_accept off;
    accept_mutex off;
}


http {
    include mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    server_tokens off;

    aio threads;
    aio_write on;
    directio 8m;
    etag on;
    ignore_invalid_headers on;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    client_max_body_size 64m;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    open_file_cache max=2000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    gzip  on;
    #gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 9;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    #gzip_min_length 256;
    gzip_min_length 32;
    gzip_types text/plain text/css text/javascript text/xml application/xml application/xml+rss application/json application/javascript application/x-javascript;

    upstream elastic {
        server load189.kmsext.dk:9201 max_fails=1 fail_timeout=1s;
        server load190.kmsext.dk:9201 max_fails=1 fail_timeout=1s;
#        server kmsload154.kmsext.dk:9200 max_fails=1 fail_timeout=1s;
#        server kmsload155.kmsext.dk:9200 max_fails=1 fail_timeout=1s;
    }

    proxy_cache_path /data/nginx/ramcache/assets keys_zone=asset_cache:128m inactive=12h;

    proxy_cache_path /data/nginx/ramcache/elasticsearch keys_zone=elasticsearch_cache:128m inactive=12h;

    # HTTP server
    #
    server {
        listen       80;
#        listen       443 default_server ssl http2 deferred bind reuseport;
        server_name  test2.dataforsyningen.dk;
        root /usr/share/nginx/html;
        #        resolver 127.0.0.11 ipv6=off;
        resolver 127.0.0.11 1.1.1.1 208.67.222.222 8.8.8.8 valid=300s ipv6=off;
        resolver_timeout 5s;

        #        charset koi8-r;
        charset utf-8;

        #        access_log  logs/host.access.log  main;

        server_tokens off;

        #gzip  off;

        valid_referers server_names;

        location ~* ^/asset/(Images|PDF|JSON)/(.*)$ {
            #            if ($invalid_referer) {
            #                return 403 Forbidden;
            #            }
            expires 1d;
            add_header Cache-Control public;
            access_log off;
            tcp_nodelay off;
            open_file_cache max=3000 inactive=120s;
            open_file_cache_valid 45s;
            open_file_cache_min_uses 2;
            open_file_cache_errors off;
            root /data/nginx;
            try_files /assets/$1/$2 =404;
        }

        location ~* ^/es/(.*)$ {
            #            if ($invalid_referer) {
            #                return 403 Forbidden;
            #            }
            expires 1m;
            proxy_cache elasticsearch_cache;
            proxy_cache_key "$request_method$request_uri$request_body";
            proxy_cache_valid 404 302 301 5m;
            proxy_cache_valid 200 1m;
            proxy_cache_use_stale updating error timeout http_500 http_502 http_503 http_504;
            proxy_cache_revalidate on;
            proxy_cache_background_update on;
            proxy_cache_lock on;
            proxy_cache_convert_head off;
            proxy_cache_methods GET POST HEAD;
            proxy_hide_header "X-Powered-By";
            proxy_hide_header Server;
            proxy_pass_request_body on;
            proxy_pass_request_headers on;
            proxy_redirect off;
            proxy_method $request_method;
            proxy_http_version 1.1;
            add_header Accept "application/json";
            add_header Content-Type "application/json";
            proxy_set_header Accept "application/json";
            proxy_set_header Content-Type "application/json";
            proxy_pass http://elastic/$1?$args;
        }

        location ~* ^/(?:.*/)*(.*)\.(js|css|png|ico|svg|jpe?g|ttf|woff2)$ {
            #            if ($invalid_referer) {
            #                return 403 Forbidden;
            #            }
            expires 1d;
            add_header Cache-Control public;
            try_files $uri $uri/ /$1.$2 =404;
        }

        location = /robots.txt {
            #            if ($invalid_referer) {
            #                return 403 Forbidden;
            #            }
            expires 1d;
            try_files $uri $uri/ robots.txt =404;
            allow all;
            log_not_found off;
            access_log off;
        }

        location / {
            #            if ($invalid_referer) {
            #            if ($host !~ test2.dataforsyningen.dk) {
            #                return 403 Forbidden;
            #            }
            expires 1s;
            add_header Cache-Control public;
            index index.html;
            try_files $uri $uri/ /index.html =666;
        }

    }
}
